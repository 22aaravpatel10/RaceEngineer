<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Overcut Dashboard</title>
    <script src="plotly-2.27.0.min.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        :root {
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent-color: #0A84FF;
            --radius: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-stack);
            margin: 0;
            padding: 16px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Header & Controls --- */
        #header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            margin-bottom: 16px;
            -webkit-app-region: drag;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .win-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .btn-close {
            background: #FF5F56;
        }

        .btn-min {
            background: #FFBD2E;
        }

        .btn-max {
            background: #27C93F;
        }

        /* --- Mode Switcher --- */
        #mode-switcher {
            background: #2C2C2E;
            padding: 4px;
            border-radius: 20px;
            display: flex;
            gap: 4px;
            -webkit-app-region: no-drag;
        }

        .mode-btn {
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            color: #8E8E93;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #48484A;
            color: #FFF;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #dynamic-island {
            background: #2C2C2E;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #status-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FF3B30;
        }

        /* --- Layout --- */
        #main-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 1fr 60px;
            gap: 16px;
            flex: 1;
            height: calc(100% - 60px);
        }

        .panel {
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* --- Driver List --- */
        #driver-panel {
            grid-row: 1 / -1;
        }

        .list-header {
            padding: 16px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        #driver-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
        }

        .driver-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.1s;
            margin-bottom: 4px;
        }

        .driver-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .driver-row.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent-color);
        }

        .team-stripe {
            width: 4px;
            height: 24px;
            border-radius: 2px;
            margin-right: 12px;
        }

        .d-code {
            font-weight: 700;
            font-size: 15px;
            width: 40px;
        }

        .d-time {
            font-family: 'Menlo', monospace;
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* --- Chart Area --- */
        #viz-panel {
            grid-row: 1 / 2;
            position: relative;
        }

        #chart-area {
            flex: 1;
            width: 100%;
            position: relative;
        }

        /* --- Commander --- */
        #cmd-panel {
            grid-row: 2 / 3;
            grid-column: 2 / 3;
            flex-direction: row;
            align-items: center;
            padding: 0 16px;
        }

        #cmd-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: 'Menlo', monospace;
            font-size: 14px;
            outline: none;
            margin-left: 12px;
        }
    </style>
</head>

<body>

    <div id="header-bar">
        <div class="window-controls">
            <button class="win-btn btn-close" onclick="winAction('close')"></button>
            <button class="win-btn btn-min" onclick="winAction('minimize')"></button>
            <button class="win-btn btn-max" onclick="winAction('maximize')"></button>
        </div>

        <div id="mode-switcher">
            <div class="mode-btn" data-mode="PRACTICE" onclick="setMode('PRACTICE')">FP</div>
            <div class="mode-btn active" data-mode="QUALI" onclick="setMode('QUALI')">QUALI</div>
            <div class="mode-btn" data-mode="RACE" onclick="setMode('RACE')">RACE</div>
        </div>

        <div id="dynamic-island">
            <div id="status-light"></div>
            <span id="status-text">System Init...</span>
        </div>
    </div>

    <div id="main-grid">

        <div class="panel" id="driver-panel">
            <div class="list-header">Live Grid</div>
            <div id="driver-list"></div>
        </div>

        <div class="panel" id="viz-panel">
            <div id="chart-area"></div>
        </div>

        <div class="panel" id="cmd-panel">
            <span style="color: var(--accent-color); font-weight: bold;">>_</span>
            <input type="text" id="cmd-input" placeholder="Type 'Compare VER and HAM'..." autocomplete="off">
        </div>
    </div>

    <script>
        let backend = null;
        let currentMode = 'QUALI';
        let currentDriver = null;

        // --- Init ---
        function initBridge() {
            if (typeof qt !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    backend = channel.objects.bridge;
                    document.getElementById('status-light').style.background = '#30D158';
                    document.getElementById('status-text').innerText = "Connected";
                });
            } else {
                setTimeout(initBridge, 100);
            }
        }
        initBridge();

        // --- Window Actions ---
        function winAction(action) {
            if (!backend) return;
            if (action === 'close') backend.close_window();
            if (action === 'minimize') backend.minimize_window();
            if (action === 'maximize') backend.maximize_window();
        }

        // --- Mode Logic ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active');
                if (b.dataset.mode === mode) b.classList.add('active');
            });

            if (currentDriver && backend) {
                document.getElementById('status-text').innerText = `Loading ${mode}...`;
                backend.driver_mode_selected(currentDriver, currentMode);
            }
        }

        // --- UI Interactions ---
        function selectDriver(id, color, team) {
            currentDriver = id;
            document.documentElement.style.setProperty('--accent-color', color);

            document.querySelectorAll('.driver-row').forEach(el => el.classList.remove('active'));
            const row = document.getElementById(`row-${id}`);
            if (row) row.classList.add('active');

            if (backend) {
                document.getElementById('status-text').innerText = `Loading ${currentMode}...`;
                backend.driver_mode_selected(id, currentMode);
            }
        }

        // --- Data Handlers ---
        function updateDriverList(drivers) {
            const list = document.getElementById('driver-list');
            list.innerHTML = '';

            drivers.forEach(d => {
                const row = document.createElement('div');
                row.className = 'driver-row';
                row.id = `row-${d.id}`;
                row.onclick = () => selectDriver(d.id, d.color, d.team);
                row.innerHTML = `
                    <div class="team-stripe" style="background: ${d.color}"></div>
                    <span class="d-code">${d.id}</span>
                    <span class="d-time">${d.lap_time}</span>
                `;
                list.appendChild(row);
            });
            document.getElementById('status-text').innerText = "Grid Ready";
        }

        function updateSessionStatus(payload) {
            document.getElementById('status-text').innerText = payload.text;
        }

        // --- CHART LAYOUTS ---
        const layout_base = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: '-apple-system', color: '#8E8E93' },
            margin: { t: 40, r: 20, l: 50, b: 40 },
            xaxis: { showgrid: false, zeroline: false, color: '#444' },
            yaxis: { showgrid: false, zeroline: false, color: '#444' },
            showlegend: false
        };

        // --- SMART RENDERER ---
        function renderAnalysis(data) {
            console.log("Rendering Mode:", data.mode);
            const layout = JSON.parse(JSON.stringify(layout_base));
            layout.title = { text: data.title, font: { color: '#FFF', size: 14 } };

            // 1. PRACTICE MODE (Scatter Plot of Laps)
            if (data.mode === 'PRACTICE') {
                const trace = {
                    x: data.x, y: data.y,
                    mode: 'lines+markers',
                    type: 'scatter',
                    line: { color: data.color || '#0A84FF', shape: 'spline', width: 2 },
                    marker: { size: 6, color: '#FFF' }
                };
                layout.yaxis.title = { text: "Lap Time (s)", font: { color: '#8E8E93' } };
                layout.xaxis.title = { text: "Lap Number", font: { color: '#8E8E93' } };
                Plotly.newPlot('chart-area', [trace], layout, { displayModeBar: false });
            }

            // 2. QUALI MODE (Speed Trace)
            else if (data.mode === 'QUALI') {
                const traceSpeed = {
                    x: data.distance, y: data.speed,
                    type: 'scatter', mode: 'lines', name: 'Speed',
                    line: { color: data.color || '#FFD60A', width: 2 }
                };
                const traceThrottle = {
                    x: data.distance, y: data.throttle,
                    type: 'scatter', mode: 'lines', name: 'Throttle',
                    yaxis: 'y2',
                    line: { color: '#30D158', width: 1 },
                    fill: 'tozeroy',
                    opacity: 0.3
                };
                layout.yaxis2 = { overlaying: 'y', side: 'right', showgrid: false, visible: false };
                layout.hovermode = 'x unified';
                Plotly.newPlot('chart-area', [traceSpeed, traceThrottle], layout, { displayModeBar: false });
            }

            // 3. RACE MODE (Gap Trend)
            else if (data.mode === 'RACE') {
                const trace = {
                    x: data.x, y: data.y,
                    type: 'scatter', mode: 'lines',
                    fill: 'tozeroy',
                    line: { color: data.color || '#FF453A', width: 2 }
                };
                layout.yaxis.title = { text: "Gap Trend (Cumulative Î”)", font: { color: '#8E8E93' } };
                layout.xaxis.title = { text: "Lap Number", font: { color: '#8E8E93' } };
                Plotly.newPlot('chart-area', [trace], layout, { displayModeBar: false });
            }

            document.getElementById('status-text').innerText = data.title;
        }

        // --- Comparison Chart ---
        function renderChart(data) {
            const layout = JSON.parse(JSON.stringify(layout_base));
            layout.title = { text: `${data.meta.d1} vs ${data.meta.d2}`, font: { color: '#FFF' } };
            layout.showlegend = true;
            layout.legend = { x: 0, y: 1, font: { color: 'white' } };

            const trace1 = {
                x: data.axis, y: data.drivers[data.meta.d1],
                name: data.meta.d1, line: { color: data.meta.c1, width: 2 }
            };
            const trace2 = {
                x: data.axis, y: data.drivers[data.meta.d2],
                name: data.meta.d2, line: { color: data.meta.c2, width: 2 }
            };

            Plotly.newPlot('chart-area', [trace1, trace2], layout, { displayModeBar: false });
            document.getElementById('status-text').innerText = `${data.meta.d1} vs ${data.meta.d2}`;
        }

        // Global Exports
        window.updateDriverList = updateDriverList;
        window.updateSessionStatus = updateSessionStatus;
        window.renderAnalysis = renderAnalysis;
        window.renderChart = renderChart;

        // Command Input
        document.getElementById('cmd-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && backend) {
                backend.process_command(e.target.value);
                e.target.value = '';
            }
        });
    </script>
</body>

</html>